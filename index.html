<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Konfigurator Bombki</title>

    <style>
        :root {
            --panel-bg: #1e1e1e;
            --item-bg: #2d2d2d;
            --text: #e0e0e0;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            height: 100vh;
            background: #000;
            color: var(--text);
            overflow: hidden;
        }

        #canvas-container {
            flex: 1;
        }

        #ui-panel {
            width: 380px;
            background: var(--panel-bg);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #333;
        }

        .section {
            background: var(--item-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }

        h3 {
            font-size: 13px;
            margin: 0 0 12px;
            text-transform: uppercase;
            color: #888;
        }

        label {
            display: block;
            font-size: 11px;
            margin: 10px 0 5px;
            color: #aaa;
        }

        input, select, button {
            width: 100%;
            background: #111;
            color: white;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
        }

        input[type="color"] {
            height: 40px;
        }

        button {
            cursor: pointer;
        }

        button:hover {
            background: #555;
        }

        .control-row {
            display: flex;
            gap: 8px;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>

<body>

<div id="loader">Wczytywanie modelu...</div>
<div id="canvas-container"></div>

<div id="ui-panel">

    <div class="section">
        <h3>1. Oświetlenie i Tło</h3>

        <select id="hdri-select" onchange="updateHDRI(this.value)">
            <option value="textures/geislingen_an_der_steige_2k.hdr">Geislingen</option>
            <option value="textures/royal_esplanade_4k.hdr">Royal Esplanade</option>
            <option value="textures/spiaggia_di_mondello_4k.hdr">Spiaggia Mondello</option>
        </select>

        <label>Obrót HDRI</label>
        <input type="range" id="hdri-rot" min="0" max="6.283" step="0.01" value="0"
               oninput="applyRotation(this.value)">
    </div>

    <div class="section">
        <h3>2. Etykieta (Badge)</h3>

        <label>Front</label>
        <input type="file" accept="image/*" onchange="updateBadgeByIndex(0, this)">

        <label>Tył</label>
        <input type="file" accept="image/*" onchange="updateBadgeByIndex(1, this)">

        <label>Skala</label>
        <div class="control-row">
            <button onclick="setScale('badge', 0.6)">0.6x</button>
            <button onclick="setScale('badge', 1.0)">1.0x</button>
            <button onclick="setScale('badge', 1.3)">1.3x</button>
        </div>
    </div>

    <div class="section">
        <h3>3. Logo</h3>
        <input type="file" accept="image/png" onchange="updateLogo(this)">
    </div>

    <div class="section">
        <h3>4. Kolory</h3>

        <label>Bombka</label>
        <input type="color" value="#ffffff" oninput="updateColor('sphere', this.value)">

        <label>Wstążka</label>
        <input type="color" value="#ffffff" oninput="updateColor('ribbon', this.value)">
    </div>

</div>

<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

let scene, camera, renderer, controls;
let model;
let pmremGenerator;
let currentHDRTexture = null;

const texLoader = new THREE.TextureLoader();

init();

function init() {

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(
        40,
        (window.innerWidth - 380) / window.innerHeight,
        0.1,
        100
    );
    camera.position.set(0, 0.5, 4);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth - 380, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;

    document.getElementById('canvas-container').appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    pmremGenerator = new THREE.PMREMGenerator(renderer);

    updateHDRI(document.getElementById('hdri-select').value);

    new GLTFLoader().load('Bombka.glb', gltf => {
        model = gltf.scene;
        scene.add(model);
        document.getElementById('loader').style.display = 'none';
    });

    animate();
}

/* ================= HDRI ================= */

window.updateHDRI = (path) => {
    new RGBELoader().load(path, texture => {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        currentHDRTexture = texture;
        rebuildHDR();
    });
};

window.applyRotation = (value) => {
    if (!currentHDRTexture) return;
    currentHDRTexture.rotation = parseFloat(value);
    rebuildHDR();
};

function rebuildHDR() {
    const envMap = pmremGenerator.fromEquirectangular(currentHDRTexture).texture;
    scene.environment = envMap;
    scene.background = envMap;
}

/* ================= BADGE ================= */

window.updateBadgeByIndex = (index, input) => {
    if (!input.files[0] || !model) return;

    const target = index === 0 ? 'badge_front' : 'badge_back';
    const url = URL.createObjectURL(input.files[0]);

    texLoader.load(url, tex => {
        tex.flipY = false;
        tex.colorSpace = THREE.SRGBColorSpace;
        tex.anisotropy = renderer.capabilities.getMaxAnisotropy();

        model.traverse(n => {
            if (n.isMesh && n.name.toLowerCase().includes(target)) {
                n.material.map = tex;
                n.material.transparent = true;
                n.material.alphaTest = 0.01;
                n.material.needsUpdate = true;
            }
        });
    });
};

/* ================= LOGO ================= */

window.updateLogo = (input) => {
    if (!input.files[0] || !model) return;

    const url = URL.createObjectURL(input.files[0]);

    texLoader.load(url, tex => {
        tex.flipY = false;
        tex.colorSpace = THREE.SRGBColorSpace;

        model.traverse(n => {
            if (n.isMesh && n.name.toLowerCase().includes('logo')) {
                n.material.map = tex;
                n.material.transparent = true;
                n.material.alphaTest = 0.01;
                n.material.needsUpdate = true;
            }
        });
    });
};

/* ================= KOLORY ================= */

window.updateColor = (name, hex) => {
    if (!model) return;
    model.traverse(n => {
        if (n.isMesh && n.name.toLowerCase().includes(name)) {
            n.material.color.set(hex);
        }
    });
};

/* ================= SKALA ================= */

window.setScale = (name, scale) => {
    if (!model) return;
    model.traverse(n => {
        if (n.name.toLowerCase().includes(name)) {
            n.scale.setScalar(scale);
        }
    });
};

/* ================= LOOP ================= */

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

</script>

</body>
</html>
